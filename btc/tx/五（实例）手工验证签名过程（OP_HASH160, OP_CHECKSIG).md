### 基本信息
block hash：  
0000000049a63b4dda3a43450c19d085d6c28bfb4cbb2e0576815d7f31919c5d

输出TXID:  
74c1a6dd6e88f73035143f8fc7420b5c395d28300a70bb35b943f7f2eddc656d

输入TXID:  
131f68261e28a80c3300b048c4c51f3ca4745653ba7ad6b20cc9188322818f25

--- 
### 手工验证签名过程  
scriptPubKey：76a9146934efcef36903b5b45ebd1e5f862d1b63a99fa588ac

> 翻译为：
76		a9		14		     6934efcef36903b5b45ebd1e5f862d1b63a99fa5	88			ac
DUP HASH160 PUSHDATA(20)[6934efcef36903b5b45ebd1e5f862d1b63a99fa5] EQUALVERIFY CHECKSIG

> 6934efcef36903b5b45ebd1e5f862d1b63a99fa5是公钥（见下面）->sha256->ripemd160之后的地址：pkh

scriptSig：  
493046022100b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1022100d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b014104f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc

翻译为：
> 49		//长度
3046022100b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1022100d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b			//摘要签名  
01		//SIGHASH_ALL
04f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc		//公钥

#### 一 验证op_hash160(等同于做一次hash256, ripemd160)。
04f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc		//pk。如上所示，附加在scriptSig的后半截  
vs  
6934efcef36903b5b45ebd1e5f862d1b63a99fa5	//pk hash

步骤如下（需要安装binascii, hashlib包）：  
- 将16进制公钥字符串  
04f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc

- 转化为字符  
a=binascii.a2b_hex('04f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc')

- 计算sha256得到b  
b=hashlib.sha256(a).hexdigest()

- 把16进制的b转换为字符  
c=binascii.a2b_hex(b)

- 计算ripemd160  
hashlib.new('ripemd160', c).hexdigest()

- 比较是否一致

#### 二：计算op_checksig


私钥签名：  
3046022100b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1022100d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b

公钥： 
04f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc

1.计算Tx的摘要  
- 首先得到rawtransaction  
01000000016d65dcedf2f743b935bb700a30285d395c0b42c78f3f143530f7886edda6c17400000000 ***8c493046022100b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1022100d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b014104f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc*** fffffff0240420f000000000043410403c344438944b1ec413f7530aaa6130dd13562249d07d53ba96d8ac4f59832d05c837e36efd9533a6adf1920465fed2a4553fb357844f2e41329603c320753f4acc0aff62901000000434104f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dcac00000000

- 其次，移除scriptsig（加粗）部分，替换为本vin对应的prevout输出的脚本（记得加上长度）：  
01000000016d65dcedf2f743b935bb700a30285d395c0b42c78f3f143530f7886edda6c17400000000 ***1976a9146934efcef36903b5b45ebd1e5f862d1b63a99fa588ac*** ffffffff0240420f000000000043410403c344438944b1ec413f7530aaa6130dd13562249d07d53ba96d8ac4f59832d05c837e36efd9533a6adf1920465fed2a4553fb357844f2e41329603c320753f4acc0aff62901000000434104f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dcac00000000

- 第三，末尾加上sig标签，比如说是SIGHASH_ALL。  
01000000016d65dcedf2f743b935bb700a30285d395c0b42c78f3f143530f7886edda6c174000000001976a9146934efcef36903b5b45ebd1e5f862d1b63a99fa588acffffffff0240420f000000000043410403c344438944b1ec413f7530aaa6130dd13562249d07d53ba96d8ac4f59832d05c837e36efd9533a6adf1920465fed2a4553fb357844f2e41329603c320753f4acc0aff62901000000434104f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dcac00000000 ***01000000***

- 第四；两次hash256。得到（注意，在python版本中，只需要第一次sha256的结果）：  
braw=raw.decode('hex')  
a=hashlib.sha256(braw).hexdigest()  
ba=a.decode('hex')  
hashlib.sha256(ba).hexdigest()  

- 结果:  
sighash:cc3d10f8cd2c90504e4c151980572c76fba46bbfe73f9a0410188bca0158a296

2.解析私钥签名。签名是der编码的数据，需要解码成真实签名，包括r,s两个部分    
3046022100b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1022100d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b

>30	//表明der的开始  
46	//数据总长度70  
02	//一段数据开始（r)  
21	//数据长度33  
00b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1	  
02	//另一段数据开始（s)  
21   //数据长度33  
00d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b  

真实的签名数据 （去除前缀00）。sig为64位：  
sig = r+s = b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b


3. 传入解析后的签名，公钥和摘要本身。计算是否相等  
 VerifySignature(sig, pubkey, sighash)

---
python版本  
import ecdsa  
import hashlib  

#注意奇葩：这个摘要(msg)不是sha256两次后的cc3d10f8cd2c90504e4c151980572c76fba46bbfe73f9a0410188bca0158a296。而是第一次的sha256结果。  
msg='76b14a5744f852c977786d97ca584d4a0f8de71aa43c79874e00da0e01640f17'  

sig='b687c4436277190953466b3e4406484e89a4a4b9dbefea68cf5979f74a8ef5b1d32539ffb88736f3f9445fa6dd484b443ebb31af1471ee65071c7414e3ec007b'  

#注意pk相比比特币公钥去掉了第一个byte（04）。第一个byte是比特币自行加上的，并不是规范。pk是64位  
pk='f9804cfb86fb17441a6562b07c4ee8f012bdb2da5be022032e4b87100350ccc7c0f4d47078b06c9d22b0ec10bdce4c590e0d01aed618987a6caa8c94d74ee6dc'

bpk=pk.decode('hex')  
bsig=sig.decode('hex')  
bmsg=msg.decode('hex')  

vk=ecdsa.VerifyingKey.from_string(bpk, curve=ecdsa.SECP256k1)  
#verify函数对bmsg进行第二次hash.因此我们需要传入第一次hash的结果。  
a=vk.verify(bsig, bmsg, hashlib.sha256)  
print a  

注意事项：  
https://bitcoin.stackexchange.com/questions/62446/signature-verification-in-python

-----需要安装esdsa包  
sudo pip install ecdsa
